name: Test AOAI Responses API

on:
  workflow_dispatch:

jobs:
  response-test:
    name: Run & validate responses-basic-aoai-v1.py
    runs-on: ubuntu-latest
    environment: responses

    steps:
      - name: â¬‡ï¸ Check out repo
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   CORE TEST STEP   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§ª Run script & build report
        id: test
        env:
          AZURE_OPENAI_API_KEY:        ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_V1_API_ENDPOINT: ${{ secrets.AZURE_OPENAI_V1_API_ENDPOINT }}
          AZURE_OPENAI_API_MODEL:       ${{ secrets.AZURE_OPENAI_API_MODEL }}
        run: |
          python - <<'PY'
import datetime, json, os, subprocess, sys, textwrap, shlex, pathlib

# Execute the existing script and capture its stdout / exit code
proc = subprocess.run(
    [sys.executable, "responses-basic-aoai-v1.py"],
    capture_output=True, text=True
)
output     = proc.stdout.strip()
error_code = proc.returncode
passed     = bool(output) and error_code == 0   # tweak this test however you like

result = {
    "run_timestamp_utc": datetime.datetime.utcnow().isoformat(timespec="seconds") + "Z",
    "output": output,
    "pass": passed,
    "error_code": error_code,
}

path = pathlib.Path("aoai_test_result.json")
path.write_text(json.dumps(result, indent=2), encoding="utf-8")

# Surface the â€œpassâ€ status to later steps
print(f"pass={passed}", file=sys.stderr)
# Exit nonâ€‘zero only if you want the job to fail on an invalid response:
if not passed:
    sys.exit(error_code or 1)
PY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   UPLOAD REPORT   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¤ Upload test artifact
        if: always()                 # run even if the previous step failed
        uses: actions/upload-artifact@v4
        with:
          name: aoai-response-test
          path: aoai_test_result.json
